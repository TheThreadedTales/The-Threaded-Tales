<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category | The Threaded Tales</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Navbar -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="index.html" class="text-2xl font-bold">üßµ The Threaded Tales</a>
      <button id="cart-btn" class="relative">
        üõí
        <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-1">0</span>
      </button>
    </div>
  </header>

  <!-- Page Heading -->
  <section class="max-w-7xl mx-auto px-4 py-8">
    <h1 id="category-title" class="text-3xl font-bold text-gray-800 mb-6"></h1>
    <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  </section>

  <!-- ‚úÖ Product Details Modal (same as homepage) -->
  <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl w-full relative">
      <button id="close-product-modal" class="absolute top-2 right-2 text-gray-600 hover:text-black text-2xl">&times;</button>
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Left: Images -->
        <div class="relative">
          <img id="modal-main-img" src="" alt="" class="w-full h-80 object-contain cursor-zoom-in"/>
          <button id="prev-img" class="absolute top-1/2 left-2 bg-gray-800 text-white p-2 rounded-full">‚ùÆ</button>
          <button id="next-img" class="absolute top-1/2 right-2 bg-gray-800 text-white p-2 rounded-full">‚ùØ</button>
          <div id="modal-thumbnails" class="flex gap-2 mt-2 overflow-x-auto"></div>
        </div>
        <!-- Right: Info -->
        <div>
          <h2 id="modal-title" class="text-xl font-bold mb-2"></h2>
          <p id="modal-price" class="text-lg text-green-600 mb-2"></p>
          <p id="modal-description" class="text-sm text-gray-600 mb-4"></p>
          <div class="flex items-center mb-4">
            <button id="decrease-qty" class="px-2 py-1 border">-</button>
            <span id="product-qty" class="px-4">1</span>
            <button id="increase-qty" class="px-2 py-1 border">+</button>
          </div>
          <button id="add-to-cart" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">Add to Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
      <button id="close-cart" class="absolute top-2 right-4 text-gray-800 hover:text-black text-2xl">&times;</button>
      <h2 class="text-2xl font-bold mb-4">Your Cart</h2>
      <div id="cart-items" class="space-y-4"></div>
      <p class="text-lg font-semibold mt-4">Total: ‚Çπ<span id="cart-total">0</span></p>
      <button id="checkout" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Checkout on WhatsApp</button>
    </div>
  </div>

  <!-- ‚úÖ Toast Notification -->
  <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hidden">Added to Cart!</div>

  <script>
    let products = [];
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let currentImages = [];
    let currentIndex = 0;
    let selectedProduct = null;

    const params = new URLSearchParams(window.location.search);
    const category = params.get("category");
    document.getElementById("category-title").innerText = category ? category : "All Products";

    // Fetch products and filter by category
    fetch("handloom_products.json")
      .then(res => res.json())
      .then(data => {
        products = data;
        let filtered = category ? products.filter(p => p.category.toUpperCase() === category.toUpperCase()) : products;
        renderProducts(filtered);
      });

    function renderProducts(list) {
      const container = document.getElementById("products-container");
      container.innerHTML = "";
      list.forEach(p => {
        const div = document.createElement("div");
        div.className = "bg-white rounded-lg shadow hover:shadow-lg p-4 cursor-pointer";
        div.innerHTML = `
          <img src="${p.images[0]}" alt="${p.name}" class="w-full h-48 object-cover mb-2 rounded">
          <h3 class="font-bold">${p.name}</h3>
          <p class="text-green-600 font-semibold">‚Çπ${p.price}</p>
        `;
        div.addEventListener("click", () => openProductModal(p));
        container.appendChild(div);
      });
    }

    // Product Modal Functions
    function openProductModal(product) {
      selectedProduct = product;
      currentImages = product.images;
      currentIndex = 0;
      document.getElementById("modal-main-img").src = currentImages[0];
      document.getElementById("modal-title").innerText = product.name;
      document.getElementById("modal-price").innerText = "‚Çπ" + product.price;
      document.getElementById("modal-description").innerText = product.description;
      document.getElementById("product-qty").innerText = 1;
      renderThumbnails();
      document.getElementById("product-modal").classList.remove("hidden");
    }

    function renderThumbnails() {
      const thumbs = document.getElementById("modal-thumbnails");
      thumbs.innerHTML = "";
      currentImages.forEach((src, i) => {
        const img = document.createElement("img");
        img.src = src;
        img.className = "w-16 h-16 object-cover border cursor-pointer " + (i===currentIndex ? "border-black" : "");
        img.addEventListener("click", () => { currentIndex = i; updateMainImg(); });
        thumbs.appendChild(img);
      });
    }

    function updateMainImg() {
      document.getElementById("modal-main-img").src = currentImages[currentIndex];
      renderThumbnails();
    }

    // Event Listeners for Modal
    document.getElementById("close-product-modal").addEventListener("click", () => {
      document.getElementById("product-modal").classList.add("hidden");
    });
    document.getElementById("prev-img").addEventListener("click", () => {
      currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
      updateMainImg();
    });
    document.getElementById("next-img").addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % currentImages.length;
      updateMainImg();
    });
    document.getElementById("increase-qty").addEventListener("click", () => {
      document.getElementById("product-qty").innerText++;
    });
    document.getElementById("decrease-qty").addEventListener("click", () => {
      let qty = parseInt(document.getElementById("product-qty").innerText);
      if (qty > 1) document.getElementById("product-qty").innerText = qty - 1;
    });
    document.getElementById("add-to-cart").addEventListener("click", () => {
      let qty = parseInt(document.getElementById("product-qty").innerText);
      addToCart(selectedProduct, qty);
      document.getElementById("product-modal").classList.add("hidden");
      showToast();
    });

    // Cart Functions
    function addToCart(product, qty) {
      const existing = cart.find(item => item.id === product.id);
      if (existing) {
        existing.qty += qty;
      } else {
        cart.push({ ...product, qty });
      }
      updateCart();
    }

    function updateCart() {
      localStorage.setItem("cart", JSON.stringify(cart));
      document.getElementById("cart-count").innerText = cart.reduce((sum, i) => sum + i.qty, 0);
      const cartItems = document.getElementById("cart-items");
      cartItems.innerHTML = "";
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.qty;
        const div = document.createElement("div");
        div.className = "flex justify-between items-center border-b pb-2";
        div.innerHTML = `
          <div>
            <h4 class="font-bold">${item.name}</h4>
            <p>‚Çπ${item.price} √ó ${item.qty}</p>
          </div>
          <button class="text-red-500">Remove</button>
        `;
        div.querySelector("button").addEventListener("click", () => {
          cart = cart.filter(c => c.id !== item.id);
          updateCart();
        });
        cartItems.appendChild(div);
      });
      document.getElementById("cart-total").innerText = total;
    }

    // Toast
    function showToast() {
      const toast = document.getElementById("toast");
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2000);
    }

    // Open/Close Cart
    document.getElementById("cart-btn").addEventListener("click", () => {
      document.getElementById("cart-modal").classList.remove("hidden");
      updateCart();
    });
    document.getElementById("close-cart").addEventListener("click", () => {
      document.getElementById("cart-modal").classList.add("hidden");
    });

    // Checkout on WhatsApp
    document.getElementById("checkout").addEventListener("click", () => {
      let msg = "Hello, I'd like to order:\n";
      cart.forEach(item => {
        msg += `${item.name} - ‚Çπ${item.price} √ó ${item.qty}\n`;
      });
      msg += `\nTotal: ‚Çπ${document.getElementById("cart-total").innerText}`;
      window.open("https://wa.me/91XXXXXXXXXX?text=" + encodeURIComponent(msg), "_blank");
    });

    // Initialize cart count
    updateCart();
  </script>
</body>
</html>
